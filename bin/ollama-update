#!/bin/bash

# Ollama Model Updater

# Check if ollama is available
if ! command -v ollama &> /dev/null; then
    echo "Error: ollama is not installed or not in PATH" >&2
    exit 1
fi

# Check if ollama service is running
if ! timeout 10 ollama list &> /dev/null; then
    echo "Error: Cannot connect to ollama service. Please ensure ollama is running." >&2
    exit 1
fi

echo "=== Ollama Model Updater ==="
echo "Checking for installed models..."

# Get list of models
models_output=$(ollama list 2>/dev/null || true)

if [[ -z "$models_output" || "$models_output" == "No models available." ]]; then
    echo "Warning: No models found."
    echo ""
    echo "Tip: Run 'ollama pull llama2' to download your first model"
    exit 0
fi

# Parse model names
model_names=()

# Skip the header and extract model names
while IFS= read -r line; do
    # Skip header line and empty lines
    if [[ -z "$line" ]] || [[ "$line" =~ ^NAME ]]; then
        continue
    fi

    # Extract first column (model name)
    model_name=$(echo "$line" | awk '{print $1}')

    # Add to array if not empty
    if [[ -n "$model_name" ]]; then
        model_names+=("$model_name")
    fi
done <<< "$models_output"

if [[ ${#model_names[@]} -eq 0 ]]; then
    echo "Warning: No models found or unable to parse model list."
    exit 0
fi

echo "Found ${#model_names[@]} model(s)"
echo ""

# Display models
echo "Models to update:"
for i in "${!model_names[@]}"; do
    printf "  %d. %s\n" $((i+1)) "${model_names[i]}"
done
echo ""

# Update all models
updated=0
failed=0
total=${#model_names[@]}

echo "Starting model updates..."
echo ""

# Process each model
for model in "${model_names[@]}"; do
    printf "Updating %s... " "$model"

    # Run ollama pull and check exit code
    ollama pull "$model" >/dev/null 2>&1
    exit_code=$?

    if [[ $exit_code -eq 0 ]]; then
        printf "✓ Updated\n"
        ((updated++))
    else
        printf "✗ Failed\n"
        ((failed++))
    fi
done

echo ""
echo "=== Update Summary ==="
printf "Successfully updated: %d/%d models\n" "$updated" "$total"

if [[ $failed -gt 0 ]]; then
    printf "Failed to update: %d models\n" "$failed"
    echo ""
    echo "Tip: Check your internet connection and try again"
fi

if [[ $updated -gt 0 ]]; then
    echo ""
    echo "✓ All models are up to date!"
fi