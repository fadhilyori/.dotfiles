#!/bin/bash

# NPM Global Package Updater

# Check if npm is available
if ! command -v npm &> /dev/null; then
    echo "Error: npm is not installed or not in PATH" >&2
    exit 1
fi

echo "=== NPM Global Package Updater ==="
echo "Checking for outdated packages..."

# Get list of outdated packages
outdated_text=$(npm outdated -g 2>/dev/null || true)

if [[ -z "$outdated_text" ]]; then
    echo "No outdated packages found."
    echo ""
    echo "All global packages are up to date!"
    exit 0
fi

# Parse package names - skip header line
package_names=()
while IFS= read -r line; do
    # Skip header line and empty lines
    if [[ -z "$line" ]] || [[ "$line" =~ ^Package ]]; then
        continue
    fi

    # Extract first column (package name)
    package_name=$(echo "$line" | awk '{print $1}')

    # Add to array if not empty
    if [[ -n "$package_name" ]]; then
        package_names+=("$package_name")
    fi
done <<< "$outdated_text"

if [[ ${#package_names[@]} -eq 0 ]]; then
    echo "No outdated packages found or unable to parse package list."
    exit 0
fi

echo "Found ${#package_names[@]} outdated package(s)"
echo ""

# Display packages
echo "Packages to update:"
for i in "${!package_names[@]}"; do
    printf "  %d. %s\n" $((i+1)) "${package_names[i]}"
done
echo ""

# Update all packages
updated=0
failed=0
total=${#package_names[@]}

echo "Starting package updates..."
echo ""

# Process each package
for package in "${package_names[@]}"; do
    printf "Updating %s... " "$package"

    # Run npm update and check exit code
    npm update -g "$package" >/dev/null 2>&1
    exit_code=$?

    if [[ $exit_code -eq 0 ]]; then
        printf "✓ Updated\n"
        ((updated++))
    else
        printf "✗ Failed\n"
        ((failed++))
    fi
done

echo ""
echo "=== Update Summary ==="
printf "Successfully updated: %d/%d packages\n" "$updated" "$total"

if [[ $failed -gt 0 ]]; then
    printf "Failed to update: %d packages\n" "$failed"
    echo ""
    echo "Tip: Check your internet connection and try running individual updates with 'npm update -g <package>'"
fi

if [[ $updated -gt 0 ]]; then
    echo ""
    echo "✓ All packages are up to date!"
fi